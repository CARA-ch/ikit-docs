### Need first to get an IDP Token, use https://test.ahdis.ch/eprik-cara/ to Login and copy saml2 asseriton on Line 6
### to get the token (will be only valid for short time)
# @name sts

POST https://ikit.cara.ch/dep/proxy/cara/ahdis/STS/services/SecurityTokenService HTTP/1.1
Content-Type: application/soap+xml;charset=UTF-8

<env:Envelope xmlns:env="http://www.w3.org/2003/05/soap-envelope">
   <env:Header xmlns:wsa="http://www.w3.org/2005/08/addressing">
      <wsa:Action>http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue</wsa:Action>
   <wsa:MessageID>6ed3440a-0164-49c4-b9d2-235422819e90</wsa:MessageID><wsse:Security xmlns:wsse="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd">

<saml2:Assertion xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion" xmlns:xs="http://www.w3.org/2001/XMLSchema" ID="Assertion_2685276823b626f25af297d0e6c723dc67e50b45" IssueInstant="2025-07-29T15:19:58.776Z" Version="2.0"><saml2:Issuer>test.epr.fed.hin.ch</saml2:Issuer><ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#"><ds:SignedInfo><ds:CanonicalizationMethod Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"/><ds:SignatureMethod Algorithm="http://www.w3.org/2001/04/xmldsig-more#rsa-sha256"/><ds:Reference URI="#Assertion_2685276823b626f25af297d0e6c723dc67e50b45"><ds:Transforms><ds:Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature"/><ds:Transform Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"><ec:InclusiveNamespaces xmlns:ec="http://www.w3.org/2001/10/xml-exc-c14n#" PrefixList="xs"/></ds:Transform></ds:Transforms><ds:DigestMethod Algorithm="http://www.w3.org/2001/04/xmlenc#sha256"/><ds:DigestValue>72QsQD4sM4Pd4t4r12UZyUKzAccuMmSOoStBJhSDP0Y=</ds:DigestValue></ds:Reference></ds:SignedInfo><ds:SignatureValue>RLcG3ccOhoX3nToS+a4EuFRnbBdk1kq9dc0xumvFiERTTBEhd7RPtTQvD/byYbGutK6wEwtIcSEkc7bQuvIZivEfl2af4AjegmMU50EMLdAB8YXJEm9rcFr8+xreJY8peXhKpJ5Wa0a9h+InFzYcoINqPigBerYUduPqKwohp6bZ1QKrn/0sB/vfi+2xXG3faCYeZRuqzbSpNkmLu0rKtjpW3knVg6hnA4PUS+TKus5/8SNrg+aWrApPpW/rQxPZ2K2Vsdfxph8ZLpx7pk4ar4T8HOWY9oL/9FgBMhG58NmYtMUrqnnESEIwfmXzzwllyvevxXaOBec0ssyDx5e95ziwLdbsjGBp5WF3GpqaCC1V8Ij8oXIBnAqMWerBadTa9DkxD13yMCj5LyGQLtUXuv2UleIGheBBP5dE46JRS/8Z6hugEP5f2F3rsSWGknIwlZgqInKAKGxUdhIx/vZB4uG+KBt5bJyF37Wqnf4tIPbwvCMCr6EtoWeblZEjXNt/E42yVslRSAW04HHFIS3Oj3YVDgXm1tUHu25/TvSD0/hee7wbsdifZZ1DWKEibplHwegIRmNELnzJKtuAt1GjA73ZxHa9LuV2AhhPRuUgB1eHYKw/qxns6NP6nuFiAQR2Gdy256/k1XzAhApmB2lMMoKwKG1uwher0i754v/d3g8=</ds:SignatureValue><ds:KeyInfo><ds:X509Data><ds:X509Certificate>MIIJhzCCB2+gAwIBAgIUH59ByS0i0pPqdarzE2uaUOaCBM8wDQYJKoZIhvcNAQELBQAwVjELMAkG
A1UEBhMCTkwxIDAeBgNVBAoMF1F1b1ZhZGlzIFRydXN0bGluayBCLlYuMSUwIwYDVQQDDBxRdW9W
YWRpcyBFdXJvcGUgRVYgU1NMIENBIEcxMB4XDTI1MDMwNTE2MjMyNVoXDTI2MDMwNTE2MTgwMFow
gdgxEzARBgsrBgEEAYI3PAIBAxMCQ0gxGDAWBgsrBgEEAYI3PAIBAgwHWsO8cmljaDEdMBsGA1UE
DwwUUHJpdmF0ZSBPcmdhbml6YXRpb24xGDAWBgNVBAUTD0NIRS0xMDMuNDg5LjIxODELMAkGA1UE
BhMCQ0gxEDAOBgNVBAgMB1rDvHJpY2gxFDASBgNVBAcMC1dhbGxpc2VsbGVuMRswGQYDVQQKDBJI
ZWFsdGggSW5mbyBOZXQgQUcxHDAaBgNVBAMME3Rlc3QuZXByLmZlZC5oaW4uY2gwggIiMA0GCSqG
SIb3DQEBAQUAA4ICDwAwggIKAoICAQDgAF0R4LO58R8JX/VhyY0asvH/Gff0JZHqny1drX+Lv46j
579ZJyJQDjF+sKcfBFVFjEXSi94tnyZt0pl5LCX6R5QPMVQ/8xJdAF7p62bE20DTzzhZ82Luq3oG
HBYlLnig4uRtfXitJNDpjyWqPECsgDngj6uy6X+iwklVEWcB9Gqd5ADTPxf+kG4AJdP5gRf/BLOs
svLDepcDkasjYoBlG5ehr3uytGi/pLG3UQ5YOwSyY2ygQVSUiIfhVlyAb8L9z2dsdl6AAcNDfogZ
fhBGltnxTc/3MhQPvNvKFOH3+7tvWZDUDFD6wAvknfL6Tq4D1g2XuP0XYQsFfDZ1epAsu2T/55XQ
vTIYP/Yy8TsRvaDRITDHM0C4QJ2JpaQtoIwTMuue11Af/gkSLenzRn5ho1sjlRO235ol5u2aBJZU
wlg2iVNWjmgaRf8IjnhoKXX26erXWzD/Ylmh3roLTAme5Uu15ZSCh90g2KSswwKgms6KDA16Swd7
Z963zzX/+lXFdFnSpP4QTPU03n7v+CyC6jW6Iis1pBw+UH8Pmeu0McwgcqaXIVJJxCVZyCLQ7ZVh
MHHWQnVruSJOja6EQI3R0oE7BDUOviszLAJP5CgYfKSw4DxOP4KAowPSHtT/1eH5ow05YrrijU7W
3YhcgkgEOAMOGQcAXF7et1/cI9gsUwIDAQABo4IDyDCCA8QwDAYDVR0TAQH/BAIwADAfBgNVHSME
GDAWgBRJPQ7cecXL2xKj1Q2r8s+pr+NmqTCBgwYIKwYBBQUHAQEEdzB1MEcGCCsGAQUFBzAChjto
dHRwOi8vdHJ1c3QucXVvdmFkaXNnbG9iYWwuY29tL3F1b3ZhZGlzZXVyb3BlZXZzc2xjYWcxLmNy
dDAqBggrBgEFBQcwAYYeaHR0cDovL29jc3AucXVvdmFkaXNnbG9iYWwuY29tMB4GA1UdEQQXMBWC
E3Rlc3QuZXByLmZlZC5oaW4uY2gwWgYDVR0gBFMwUTBGBgwrBgEEAb5YAAJkAQIwNjA0BggrBgEF
BQcCARYoaHR0cDovL3d3dy5xdW92YWRpc2dsb2JhbC5jb20vcmVwb3NpdG9yeTAHBgVngQwBATAd
BgNVHSUEFjAUBggrBgEFBQcDAgYIKwYBBQUHAwEwSgYDVR0fBEMwQTA/oD2gO4Y5aHR0cDovL2Ny
bC5xdW92YWRpc2dsb2JhbC5jb20vcXVvdmFkaXNldXJvcGVldnNzbGNhZzEuY3JsMB0GA1UdDgQW
BBTziGEOmKhH9zHGYB66mjhPyTE2XDAOBgNVHQ8BAf8EBAMCBaAwggH1BgorBgEEAdZ5AgQCBIIB
5QSCAeEB3wB1AJaXZL9VWJet90OHaDcIQnfp8DrV9qTzNm5GpD8PyqnGAAABlWcnpLMAAAQDAEYw
RAIgW3gywI6ei1Qzfos874fvOTZzlF6vyJ8iWBhYqT/jAnECIB5IlhsYg/B5tTEdnF8XT+Ver2l/
6qi2Xpy5tmzmMZiCAHYAGYbUxyiqb/66A294Kk0BkarOLXIxD67OXXBBLSVMx9QAAAGVZyelqgAA
BAMARzBFAiEA+Bd3NYLx8M5fKMgvQ9xufnDidxYr+zj2eSG9Y/ATO6MCIGp36DDTRJNRpysMAqkX
CAEN83umq+bDK/Pnp9gSgLXwAHYADleUvPOuqT4zGyyZB7P3kN+bwj1xMiXdIaklrGHFTiEAAAGV
ZyelXAAABAMARzBFAiEAiC0uVCDHP4BbFrDMyoYDZTZS6SsDzcxQCSC0wAAsLeECIE/08cbY2V/l
jZwJGGY9qJaukLTZlAbGbFyDqm2UO/4tAHYAyzj3FYl8hKFEX1vB3fvJbvKaWc1HCmkFhbDLFMMU
WOcAAAGVZyelLgAABAMARzBFAiAFBBW5qD36/2xUKHCLU+wkbrb/C1yFJjzOOGczLMnHZAIhAJhq
Rj0Z58IJ4hr4qrJZi34HU4DAL2B5kzBNKSjj1AhGMA0GCSqGSIb3DQEBCwUAA4ICAQB7M4zWK/81
spsfmZofRBU+Qunc6h49KuHo4LVyN/hbciXUi699BCv6xyI+YT94/5YJQkHMrz4Wo1AkTbhPyliI
JOk9ohdmIg8RS2TkftRtMdR60voHp/Yudu1ZgKsAxM94y5Z1H3Zjb0FDSqmJqeWrqCFclcpFWYZ4
ku2R/7Kc2Kw8JCEUvMWbxuU+wcVeGZVelt00ZaL/PUAQG+YFPzUZeOFPEPgwfS9yBt3SD60t8Dj9
YcgxgjjpaRcx2CAu7wNlet4EQFXUcWEMFFC8Sz0GT3vqHfB4Sl9aYh9wKnW/uTfgssBv+BvqvoeL
H9Wo6gti1XXPV2ZkWV5KWOun/REls+2yJ8WvIh7jOn0l5zt3sapFSqLrk7q8Eob0OAkMzBDi6LUm
5SkgtL+YTzuiAtAcxj3UH+0ms/ojD4NYpD0a6lp7XxBEcKOr8TJLOY2OmIynSPmZaSi6G3r0kERL
UZV3CZuFLQAgIDQXDrNge/iN/JeENU86Vw92pHQopuWBjXWXbgMLRI2nifFA6LIBGUDGeSihlgbe
U0oKCv8n20o0rL+ypC+6TiuOBZ+ums2k5tZ/fAzDAMvYeqa/x80npngULHpTZqv8eIK1PkTV+0Pq
tG1nC9fyrRds6E9M8UokkKvcUORn5hmTSuc8KsQtuVawS9Pl6L68eRcTwZhYS8kocQ==</ds:X509Certificate></ds:X509Data></ds:KeyInfo></ds:Signature><saml2:Subject><saml2:NameID Format="urn:oasis:names:tc:SAML:2.0:nameid-format:persistent">HIN_8a48175e776d770c414b37f1236b4a03553f6da1a94ccb7d990fe3c1b75941c1</saml2:NameID><saml2:SubjectConfirmation Method="urn:oasis:names:tc:SAML:2.0:cm:bearer"><saml2:SubjectConfirmationData InResponseTo="a4j8ih417g1i9i132fbg2i4f3id0g42" NotOnOrAfter="2025-07-29T17:19:58.777Z" Recipient="https://test.ahdis.ch/eprik-cara/saml/SSO/alias/hin"/></saml2:SubjectConfirmation></saml2:Subject><saml2:Conditions NotBefore="2025-07-29T15:19:58.776Z" NotOnOrAfter="2025-07-29T15:24:58.776Z"><saml2:AudienceRestriction><saml2:Audience>https://test.ahdis.ch/eprik-cara/saml/SSO/alias/hin</saml2:Audience></saml2:AudienceRestriction></saml2:Conditions><saml2:AuthnStatement AuthnInstant="2025-07-29T15:19:58.776Z" SessionNotOnOrAfter="2025-07-29T17:19:58.776Z"><saml2:AuthnContext><saml2:AuthnContextClassRef>urn:oasis:names:tc:SAML:2.0:ac:classes:unspecified</saml2:AuthnContextClassRef></saml2:AuthnContext></saml2:AuthnStatement><saml2:AttributeStatement><saml2:Attribute Name="X-HIN-USEREXTID"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">68545</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="X-HIN-EAN-NO-MEDICAL"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">2000040030829</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="X-HIN-PERSON-CODE"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">24</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="X-HIN-COMMON-NAME"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">Oliver Egger</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="X-HIN-LOCATION"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">Zürich</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="X-HIN-USERTYPE"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">Personal</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="X-HIN-LANGUAGE"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">de</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="GLN" NameFormat="urn:oasis:names:tc:ebcore:partyid-type:DataUniversalNumberingSystem:0060"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">2000040030829</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="dateofbirth"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">1900-01-01+01:00</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="X-HIN-LOGIN-NAME"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">oliegg1</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="X-HIN-INSTITUTION-CODE"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">1</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="X-HIN-SESSION-IDENTIFIER"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">6eed10ac480a9xmrEejkCeyvRbABVOet+HpJIrjAlJVZDJO1U6TBGQo=</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="X-HIN-ORGANIZATION"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">ahdis ag</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="X-HIN-ASAS-UserId"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">68545</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname" NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:uri"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">Egger</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="X-HIN-COUNTRY"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">ch</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="X-HIN-SURNAME"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">Egger</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="X-HIN-POSTALCODE"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">8005</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname" NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:uri"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">Oliver</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="X-HIN-POSTAL-CODE"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">8005</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="X-ASAS-UserId"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">68545</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="X-HIN-MAIL"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">test-oliver.egger@hintest.ch</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="X-HIN-TEST-CODE"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">1</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="X-HIN-ADDRESS-1"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">Sihlquai 131</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="X-HIN-GIVEN-NAME"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">Oliver</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="X-HIN-ORGANIZATION-ID"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">M107098</saml2:AttributeValue></saml2:Attribute><saml2:Attribute Name="X-HIN-AUTH-METHOD"><saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">FUTURAE</saml2:AttributeValue></saml2:Attribute></saml2:AttributeStatement></saml2:Assertion>
   </wsse:Security></env:Header>
   <env:Body>
      <wst:RequestSecurityToken xmlns:wst="http://docs.oasis-open.org/ws-sx/ws-trust/200512">
         <wst:RequestType>http://docs.oasis-open.org/ws-sx/ws-trust/200512/Issue</wst:RequestType>
         <wsp:AppliesTo xmlns:wsp="http://schemas.xmlsoap.org/ws/2004/09/policy">
            <wsa:EndpointReference xmlns:wsa="http://www.w3.org/2005/08/addressing">
               <wsa:Address>https://test.ahdis.ch/mag-cara</wsa:Address>
            </wsa:EndpointReference>
         </wsp:AppliesTo>
         <wst:TokenType>http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV2.0</wst:TokenType>
         <wst:Claims Dialect="http://www.bag.admin.ch/epr/2017/annex/5/amendment/2">
         <saml2:Attribute xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion" Name="urn:oasis:names:tc:xacml:2.0:resource:resource-id"><saml2:AttributeValue xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">761337614808965105^^^&amp;2.16.756.5.30.1.127.3.10.3&amp;ISO</saml2:AttributeValue></saml2:Attribute><saml2:Attribute xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion" Name="urn:oasis:names:tc:xspa:1.0:subject:purposeofuse"><saml2:AttributeValue xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:anyType"><PurposeOfUse xmlns="urn:hl7-org:v3" code="NORM" codeSystem="2.16.756.5.30.1.127.3.10.5" codeSystemName="eHealth Suisse Verwendungszweck" displayName="Normal Access" xsi:type="CE"/></saml2:AttributeValue></saml2:Attribute><saml2:Attribute xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion" Name="urn:oasis:names:tc:xacml:2.0:subject:role" NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:unspecified"><saml2:AttributeValue xmlns:xs="http://www.w3.org/2001/XMLSchema"><Role xmlns="urn:hl7-org:v3" code="HCP" codeSystem="2.16.756.5.30.1.127.3.10.6" codeSystemName="eHealth Suisse EPR Akteure" displayName="Healthcare professional" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="CE"/></saml2:AttributeValue></saml2:Attribute></wst:Claims>
      </wst:RequestSecurityToken>
   </env:Body>
</env:Envelope>

### ITI-18 request with above token
### Note: xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:s="http://www.w3.org/2001/XMLSchema" has to be included in the request for wsse:security because they are not defined in the assertion itself

# @name iti18
POST https://ikit.cara.ch/dep/proxy/cara/ahdis/XCA/services/InitiatingGatewayService  HTTP/1.1
Content-Type: application/soap+xml;charset=UTF-8

<soap:Envelope xmlns:soap="http://www.w3.org/2003/05/soap-envelope"><soap:Header><wsse:Security xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:s="http://www.w3.org/2001/XMLSchema" xmlns:wsse="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd">

{{sts.response.body./*[local-name()='Envelope']/*[local-name()='Body']/*[local-name()='RequestSecurityTokenResponseCollection']/*[local-name()='RequestSecurityTokenResponse']/*[local-name()='RequestedSecurityToken']}}

</wsse:Security><Action soap:mustUnderstand="true" xmlns="http://www.w3.org/2005/08/addressing">urn:ihe:iti:2007:RegistryStoredQuery</Action><MessageID xmlns="http://www.w3.org/2005/08/addressing">urn:uuid:33bb72fc-59d3-4525-8737-fba8bea73d7d</MessageID><To xmlns="http://www.w3.org/2005/08/addressing">http://test.ahdis.ch/eprik-cara/services/iti18Endpoint</To><ReplyTo xmlns="http://www.w3.org/2005/08/addressing"><Address>http://www.w3.org/2005/08/addressing/anonymous</Address></ReplyTo></soap:Header><soap:Body><ns4:AdhocQueryRequest xmlns:ns6="urn:oasis:names:tc:ebxml-regrep:xsd:lcm:3.0" xmlns:ns5="urn:ihe:iti:xds-b:2007" xmlns:ns4="urn:oasis:names:tc:ebxml-regrep:xsd:query:3.0" xmlns:ns3="urn:oasis:names:tc:ebxml-regrep:xsd:rs:3.0" xmlns:ns2="urn:oasis:names:tc:ebxml-regrep:xsd:rim:3.0"><ns4:ResponseOption returnType="LeafClass" returnComposedObjects="true"/><ns2:AdhocQuery id="urn:uuid:14d4debf-8f97-4251-9a74-a90016b0af0d"><ns2:Slot name="$XDSDocumentEntryPatientId"><ns2:ValueList><ns2:Value>'100000712^^^&amp;2.16.756.5.30.1.177.2.2.1.1&amp;ISO'</ns2:Value></ns2:ValueList></ns2:Slot><ns2:Slot name="$XDSDocumentEntryStatus"><ns2:ValueList><ns2:Value>('urn:oasis:names:tc:ebxml-regrep:StatusType:Approved')</ns2:Value></ns2:ValueList></ns2:Slot></ns2:AdhocQuery></ns4:AdhocQueryRequest></soap:Body></soap:Envelope>


### ITI-43 Download the firast document from ith/cara from gassmann (fix document)

#name iti43
POST https://ikit.cara.ch/dep/proxy/cara/ahdis/XCA/services/InitiatingGatewayService HTTP/1.1
Content-Type: multipart/related; boundary=uuid:f42c35e4-54b2-45ca-8fda-ed58b11f6fce;type="application/xop+xml"; start-info="application/soap+xml; charset=utf-8"

--uuid:f42c35e4-54b2-45ca-8fda-ed58b11f6fce
Content-Type: application/xop+xml; charset=UTF-8; type="application/soap+xml"
Content-Transfer-Encoding: binary
Content-ID: <root.message@cxf.apache.org>

<soap:Envelope xmlns:soap="http://www.w3.org/2003/05/soap-envelope"><soap:Header><wsse:Security xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:s="http://www.w3.org/2001/XMLSchema" xmlns:wsse="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd">

{{sts.response.body./*[local-name()='Envelope']/*[local-name()='Body']/*[local-name()='RequestSecurityTokenResponseCollection']/*[local-name()='RequestSecurityTokenResponse']/*[local-name()='RequestedSecurityToken']}}

</wsse:Security><Action soap:mustUnderstand="true" xmlns="http://www.w3.org/2005/08/addressing">urn:ihe:iti:2007:RetrieveDocumentSet</Action><MessageID xmlns="http://www.w3.org/2005/08/addressing">urn:uuid:c0fd273c-f092-4145-a411-e2db6598f21d</MessageID><To xmlns="http://www.w3.org/2005/08/addressing">http://test.ahdis.ch/eprik-cara/services/iti43Endpoint</To><ReplyTo xmlns="http://www.w3.org/2005/08/addressing"><Address>http://www.w3.org/2005/08/addressing/anonymous</Address></ReplyTo></soap:Header><soap:Body><ns2:RetrieveDocumentSetRequest xmlns:ns7="urn:ihe:iti:rmd:2017" xmlns:ns6="urn:oasis:names:tc:ebxml-regrep:xsd:lcm:3.0" xmlns:ns5="urn:oasis:names:tc:ebxml-regrep:xsd:query:3.0" xmlns:ns4="urn:oasis:names:tc:ebxml-regrep:xsd:rs:3.0" xmlns:ns3="urn:oasis:names:tc:ebxml-regrep:xsd:rim:3.0" xmlns:ns2="urn:ihe:iti:xds-b:2007">
<ns2:DocumentRequest>
   <ns2:HomeCommunityId>urn:oid:2.16.756.5.30.1.191.1.0</ns2:HomeCommunityId>
   <ns2:RepositoryUniqueId>2.16.756.5.30.1.191.1.0.12.1.101.31</ns2:RepositoryUniqueId>
   <ns2:DocumentUniqueId>2.16.756.5.30.1.191.1.0.12.3.101^ce691aa4-ab84-4ec5-b2e1-28da24d56ccb</ns2:DocumentUniqueId>
</ns2:DocumentRequest></ns2:RetrieveDocumentSetRequest></soap:Body></soap:Envelope>
--uuid:f42c35e4-54b2-45ca-8fda-ed58b11f6fce--


### general first docuemnt

<ns2:DocumentRequest>
   <ns2:HomeCommunityId>{{iti18.response.body./*[local-name()='Envelope']/*[local-name()='Body']/*[local-name()='AdhocQueryResponse']/*[local-name()='RegistryObjectList'][1]/*[local-name()='ExtrinsicObject']/@home}}</ns2:HomeCommunityId>
   <ns2:RepositoryUniqueId>{{iti18.response.body./*[local-name()='Envelope']/*[local-name()='Body']/*[local-name()='AdhocQueryResponse']/*[local-name()='RegistryObjectList'][1]/*[local-name()='ExtrinsicObject']/*[local-name()='Slot' and @name='repositoryUniqueId']/*[local-name()='ValueList']/*[local-name()='Value']}}</ns2:RepositoryUniqueId>
   <ns2:DocumentUniqueId>{{iti18.response.body./*[local-name()='Envelope']/*[local-name()='Body']/*[local-name()='AdhocQueryResponse']/*[local-name()='RegistryObjectList'][1]/*[local-name()='ExtrinsicObject']/*[local-name()='ExternalIdentifier' and ./*[local-name()='Name']/*[local-name()='LocalizedString']/@value='XDSDocumentEntry.uniqueId']/@value}}</ns2:DocumentUniqueId>
</ns2:DocumentRequest></ns2:RetrieveDocumentSetRequest></soap:Body></soap:Envelope>


### cara (ith) rim:ExtrinsicObject home="urn:oid:2.16.756.5.30.1.191.1.0"
<ns2:DocumentRequest>
   <ns2:HomeCommunityId>urn:oid:2.16.756.5.30.1.191.1.0</ns2:HomeCommunityId>
   <ns2:RepositoryUniqueId>2.16.756.5.30.1.191.1.0.12.1.101.31</ns2:RepositoryUniqueId>
   <ns2:DocumentUniqueId>2.16.756.5.30.1.191.1.0.12.3.101^ce691aa4-ab84-4ec5-b2e1-28da24d56ccb</ns2:DocumentUniqueId>
</ns2:DocumentRequest></ns2:RetrieveDocumentSetRequest></soap:Body></soap:Envelope>

### abilis im:ExtrinsicObject home="urn:oid:2.16.756.5.30.192"

     <ns2:DocumentRequest>
        <ns2:HomeCommunityId>urn:oid:2.16.756.5.30.192</ns2:HomeCommunityId>
        <ns2:RepositoryUniqueId>2.16.756.5.30.192.2.2.1.1.2</ns2:RepositoryUniqueId>
        <ns2:DocumentUniqueId>2.25.245492265918378707513916867891723260235</ns2:DocumentUniqueId>
      </ns2:DocumentRequest>

